#!/bin/sh

[ "$COOKIE" -a "$HOST" ] || exit 1

_id=$( id -u "$SUDO_USER" )
PID="$( readlink -f "/run/user/${_id:-<none>}/ssl-vpn.pid" )"

[ "$PID" ] && {
    touch "$PID"
    chgrp ssl-vpn "$PID"

    kill -0 "$( cat "$PID" )" 2> /dev/null && {
        echo "Already running as PID $( cat "$PID" ) !!"
        exit 1
    } >&2
}

# Establish connection
echo "$COOKIE" | openconnect --background --syslog "${PID:+--pid-file=$PID}" --disable-ipv6 --no-dtls "${FINGERPRINT:+--servercert=$FINGERPRINT}" --cookie-on-stdin "${_id:+--setuid=$_id}" -- "$HOST"
